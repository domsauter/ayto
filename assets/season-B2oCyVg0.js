import{r as n,u as G,s as i,j as H}from"./auth-CiqFla1T.js";const C=n.createContext(),K=()=>n.useContext(C),O=({children:E})=>{const{profile:b}=G(),o=b?.role==="admin",[x,h]=n.useState([]),[u,f]=n.useState(null),[_,l]=n.useState(null),[p,S]=n.useState(!0),[k,m]=n.useState(!1),[B,c]=n.useState(null);n.useEffect(()=>{let a=!0;return(async()=>{S(!0);try{const{data:e,error:r}=await i.from("seasons").select("*").order("created_at",{ascending:!0});if(a){if(r)console.error("Error fetching seasons:",r),c(r.message),h([]);else{h(e);const s=localStorage.getItem("ayto-currentSeasonId");s&&e.some(d=>d.id===parseInt(s))?f(parseInt(s)):e.length>0?f(e[0].id):f(null)}S(!1)}}catch(e){a&&(console.error("fetchSeasons exception:",e),S(!1))}})(),()=>{a=!1}},[]),n.useEffect(()=>{let a=!0;return(async()=>{if(m(!0),c(null),!u){a&&(l(null),m(!1));return}try{const[{data:e,error:r},{data:s,error:d},{data:g,error:w},{data:F,error:y}]=await Promise.all([i.from("seasons").select("*").eq("id",u).single(),i.from("candidates").select("*").eq("season_id",u).order("name",{ascending:!0}),i.from("matching_nights").select("*").eq("season_id",u).order("created_at",{ascending:!0}),i.from("matching_boxes").select("*").eq("season_id",u).order("created_at",{ascending:!0})]);if(a){if(r)throw new Error(r.message);if(d)throw new Error(d.message);if(w)throw new Error(w.message);if(y)throw new Error(y.message);l({...e,candidates:s,matchingNights:g,truthBooths:F}),m(!1)}}catch(e){a&&(console.error("Error fetching season details:",e),c(e.message),l(null),m(!1))}})(),()=>{a=!1}},[u]),n.useEffect(()=>{u!==null?localStorage.setItem("ayto-currentSeasonId",u.toString()):localStorage.removeItem("ayto-currentSeasonId")},[u]);const N=n.useCallback(async a=>{if(!o)return;const{data:t,error:e}=await i.from("seasons").insert([{name:a}]).select().single();e?(console.error("Error adding season:",e),c(e.message)):(h(r=>[...r,t]),f(t.id))},[o]),q=n.useCallback(async a=>{if(!o||!window.confirm("Are you sure you want to delete this season? This action cannot be undone."))return;const{error:t}=await i.from("seasons").delete().eq("id",a);t?(console.error("Error deleting season:",t),c(t.message)):(h(e=>e.filter(r=>r.id!==a)),u===a&&f(null))},[o,u]),I=n.useCallback(a=>{f(a)},[]),A=n.useCallback(async(a,t)=>{if(!o)return;const{data:e,error:r}=await i.from("candidates").insert([{...t,season_id:a}]).select().single();r?(console.error("Error adding candidate:",r),c(r.message)):l(s=>({...s,candidates:[...s.candidates,e]}))},[o]),D=n.useCallback(async(a,t)=>{if(!o||!window.confirm("Are you sure you want to delete this candidate?"))return;const{error:e}=await i.from("candidates").delete().eq("id",t);e?(console.error("Error deleting candidate:",e),c(e.message)):l(r=>({...r,candidates:r.candidates.filter(s=>s.id!==t)}))},[o]),M=n.useCallback(async(a,t,e)=>{if(!o)return;const{data:r,error:s}=await i.from("candidates").update(e).eq("id",t).select().single();s?(console.error("Error updating candidate:",s),c(s.message)):l(d=>({...d,candidates:d.candidates.map(g=>g.id===t?r:g)}))},[o]),P=n.useCallback(async(a,t)=>{if(!o)return;const{data:e,error:r}=await i.from("matching_nights").insert([{...t,season_id:a}]).select().single();r?(console.error("Error adding matching night:",r),c(r.message)):l(s=>({...s,matchingNights:[...s.matchingNights,e]}))},[o]),T=n.useCallback(async(a,t)=>{if(!o||!window.confirm("Are you sure you want to delete this matching night?"))return;const{error:e}=await i.from("matching_nights").delete().eq("id",t);e?(console.error("Error deleting matching night:",e),c(e.message)):l(r=>({...r,matchingNights:r.matchingNights.filter(s=>s.id!==t)}))},[o]),j=n.useCallback(async(a,t,e)=>{if(!o)return;const{data:r,error:s}=await i.from("matching_nights").update(e).eq("id",t).select().single();s?(console.error("Error updating matching night:",s),c(s.message)):l(d=>({...d,matchingNights:d.matchingNights.map(g=>g.id===t?r:g)}))},[o]),L=n.useCallback(async(a,t)=>{if(!o)return;const{data:e,error:r}=await i.from("matching_boxes").insert([{...t,season_id:a}]).select().single();r?(console.error("Error adding matching box:",r),c(r.message)):l(s=>({...s,truthBooths:[...s.truthBooths,e]}))},[o]),U=n.useCallback(async(a,t)=>{if(!o||!window.confirm("Are you sure you want to delete this matching box entry?"))return;const{error:e}=await i.from("matching_boxes").delete().eq("id",t);e?(console.error("Error deleting matching box:",e),c(e.message)):l(r=>({...r,truthBooths:r.truthBooths.filter(s=>s.id!==t)}))},[o]),R=n.useCallback(async(a,t,e)=>{if(!o)return;const{data:r,error:s}=await i.from("matching_boxes").update(e).eq("id",t).select().single();s?(console.error("Error updating matching box:",s),c(s.message)):l(d=>({...d,truthBooths:d.truthBooths.map(g=>g.id===t?r:g)}))},[o]),z=n.useCallback(async(a,t)=>{console.warn("updateUserPredictions in SeasonContext might be redundant after full Supabase migration.")},[]);return H.jsx(C.Provider,{value:{seasons:x,currentSeason:_,addSeason:N,deleteSeason:q,selectSeason:I,addCandidate:A,deleteCandidate:D,updateCandidate:M,addMatchingNight:P,deleteMatchingNight:T,updateMatchingNight:j,addTruthBooth:L,deleteTruthBooth:U,updateTruthBooth:R,updateUserPredictions:z,loadingSeasons:p,loadingCurrentSeason:k,error:B,isAdmin:o},children:E})};export{O as S,K as u};
